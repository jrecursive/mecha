
/* 
 * Generated by introspectpages().
*/
pages = {};
hashes = {};

/*
 * Load a page by section -> article.
*/
function loadcontent(section, article) {
    $('#content').html("");
    $('#content').load(pages[section][article]["url"], function() {
        renderLinks();
        prettyPrint();
    });
    crumbs(section, article);
    $('a.dropdown-toggle').each(function() {
        if ($(this).text() == section) {
            $(this).parent().addClass("active");
        } else {
            $(this).parent().removeClass("active");
        }
    });
};

/*
 * Build & display breadcrumbs.
*/
function crumbs(section, article) {
    $(".article-crumb").show();
    $('#crumbs').html(
           '<ul class="breadcrumb"><li><a href="../docs/">' +
           'Mecha Documentation' + 
           '</a> <span class="divider">/</span></li><li><a class="section-link" href="#">' +
           section +
           '</a><span class="article-crumb"><span class="divider">/</span></span></li>' + 
           '<span class="article-crumb"><li class="active">' +
           article +
           '</li></span></ul>'
    );
}

/*
 * Render any display-time links.
*/
function renderLinks() {

    /*
     * Upon breadcrumb section link click, dynamically render
     *  a TOC for that section.
    */
    $(".section-link").each(function() {
        var section = $(this).text();
        $(this).attr("href", "#toc-" + section);
        $(this).click(function() {
            do_toc($(this).text());
        });
    });
}

function do_toc(section) {
    crumbs(section, "");
    $(".article-crumb").hide();
    $("#content").load("util/section-tpl.html", function() {
        $(".section-name").text(section);
        for (page in pages[section]) {
            console.log("page: " + page);
            $(".section-articles").append(
                "<li><a href='#path-" + section + "-" + page + "' class='contents-link'>" +
                    page +
                "</a>");
        }
        $(".contents-link").each(function() {
            $(this).click(function() {
                var page = $(this).text();
                console.log("loading " + section + ", " + page + ".");
                loadcontent(section, page);
            });
        });
    });
}

/* 
 * Dynamically build TOCs & links.
*/
function introspectpages() {
    $(".dropdown-toggle").each(function() {
        var section = $(this).text();
        pages[section] = {};
        hashes["#toc-" + section] = {
            "section": section,
            "type": "toc"
        };
        $(this).next().find("a").each(function() {
            var article = $(this).text();
            var url = $(this).attr("href");
            $(this).attr("href", "#path-" + section + "-" + article);
            $(this).click(function() { 
                loadcontent(section, article);
            });
            pages[section][article] = {};
            pages[section][article]["url"] = url;
            console.log(url);
            hashes["#path-" + section + "-" + article] = 
                { "section": section, 
                  "article": article,
                  "type": "article"
                };
        });
    });
    console.log(pages);
    console.log(hashes);
}

/* 
 * Mmmmm.  Documentation.
*/
$(document).ready(function() {
    introspectpages();
    do_hash(window.location.hash);

    /*
     * Ew.
    */
    var hash = window.location.hash;
    setInterval(function(){
        if (window.location.hash != hash) {
            hash = window.location.hash;
            console.log("User went back or forward to application state represented by " + hash);
            do_hash(hash);
        }
    }, 100);
});

function do_hash(hash) {
    if (!hash || hash == "") {
        loadcontent('Getting Started', 'Overview');
    }
    if (hashes[hash]) {
        var obj = hashes[hash];
        if (obj.type == "toc") {
            do_toc(obj.section);
        } else if (obj.type == "article") {
            loadcontent(obj.section, obj.article);
        }
    } else {
        window.location.hash = "#path-Getting Started-Overview";
    }
}